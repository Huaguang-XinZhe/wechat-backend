# å¾®ä¿¡å°ç¨‹åºåç«¯æœåŠ¡ - é‚€è¯·æ³¨å†ŒåŠŸèƒ½

è¿™æ˜¯ä¸€ä¸ªæ”¯æŒå¾®ä¿¡å°ç¨‹åºç™»å½•å’Œé‚€è¯·æ³¨å†ŒåŠŸèƒ½çš„ Node.js åç«¯æœåŠ¡ã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½

- âœ… å¾®ä¿¡å°ç¨‹åºç™»å½•
- âœ… é‚€è¯·ç æ³¨å†Œç³»ç»Ÿ
- âœ… ç”¨æˆ·èµ„æ–™ç®¡ç†
- âœ… JWT Token è®¤è¯
- âœ… æ”¯ä»˜åŠŸèƒ½ï¼ˆåŸæœ‰ï¼‰
- âœ… è®¢å•ç®¡ç†ï¼ˆåŸæœ‰ï¼‰

### é‚€è¯·ç ç³»ç»Ÿ

- âœ… ç³»ç»Ÿé»˜è®¤é‚€è¯·ç  `AAA`ï¼ˆä»…ä¾›å•†æˆ·æ³¨å†Œï¼Œä¸€æ¬¡æ€§ä½¿ç”¨ï¼‰
- âœ… å•†æˆ·æ³¨å†Œåè‡ªåŠ¨ç”Ÿæˆä¸ªäººé‚€è¯·ç 
- âœ… é‚€è¯·ç å¯å¤šæ¬¡ä½¿ç”¨
- âœ… ç”¨æˆ·åªèƒ½é€šè¿‡ä¸€ä¸ªé‚€è¯·ç æ³¨å†Œ
- âœ… é‚€è¯·å…³ç³»è¿½è¸ª
- âœ… é‚€è¯·ç»Ÿè®¡åŠŸèƒ½

## ğŸ“‹ æŠ€æœ¯æ ˆ

- Node.js + Express
- JWT è®¤è¯
- å†…å­˜å­˜å‚¨ï¼ˆå¼€å‘æ¨¡å¼ï¼‰
- Joi æ•°æ®éªŒè¯
- Winston æ—¥å¿—
- Docker æ”¯æŒ

## ğŸ› ï¸ å¼€å‘ç¯å¢ƒè®¾ç½®

### 1. å®‰è£…ä¾èµ–

```bash
npm install
```

### 2. ç¯å¢ƒé…ç½®

å¤åˆ¶ `env.example` åˆ° `.env` å¹¶ä¿®æ”¹é…ç½®ï¼š

```bash
cp env.example .env
```

ä¸»è¦é…ç½®é¡¹ï¼š

```env
# æœåŠ¡é…ç½®
PORT=3000
NODE_ENV=development

# JWT é…ç½®
JWT_SECRET=your-secret-key
JWT_EXPIRES_IN=7d

# å¾®ä¿¡å°ç¨‹åºé…ç½®
WECHAT_APPID=your-appid
WECHAT_SECRET=your-secret
```

### 3. å¯åŠ¨æœåŠ¡

```bash
# å¼€å‘æ¨¡å¼ï¼ˆå¸¦çƒ­é‡è½½ï¼‰
npm run dev

# ç”Ÿäº§æ¨¡å¼
npm start
```

## ğŸ§ª æµ‹è¯•

### API åŠŸèƒ½æµ‹è¯•

```bash
# é‚€è¯·ç åŠŸèƒ½å®Œæ•´æµ‹è¯•
npm run test:invite
```

### æ‰‹åŠ¨æµ‹è¯•

å¯åŠ¨æœåŠ¡åè®¿é—®ï¼š

- API æ–‡æ¡£ï¼š`GET http://localhost:3000/api`
- ç³»ç»ŸçŠ¶æ€ï¼š`GET http://localhost:3000/api/debug/status`

## ğŸ“– API æ¥å£æ–‡æ¡£

### è®¤è¯ç›¸å…³

#### 1. å¾®ä¿¡ç™»å½•

```http
POST /api/auth/login
Content-Type: application/json

{
  "code": "å¾®ä¿¡ç™»å½•code",
  "userInfo": {
    "nickName": "ç”¨æˆ·æ˜µç§°",
    "avatarUrl": "å¤´åƒåœ°å€",
    "gender": 1,
    "country": "ä¸­å›½",
    "province": "åŒ—äº¬",
    "city": "åŒ—äº¬",
    "language": "zh_CN"
  }
}
```

å“åº”ï¼š

```json
// æ–°ç”¨æˆ·
{
  "code": 200,
  "message": "æ–°ç”¨æˆ·",
  "data": {
    "isNewUser": true,
    "openid": "user_openid",
    "session_key": "session_key"
  }
}

// å·²æ³¨å†Œç”¨æˆ·
{
  "code": 200,
  "message": "ç™»å½•æˆåŠŸ",
  "data": {
    "isNewUser": false,
    "token": "jwt_token",
    "userInfo": { ... },
    "inviteCode": "ABC123",
    "inviteFrom": "AAA"
  }
}
```

#### 2. é‚€è¯·ç æ³¨å†Œ

```http
POST /api/auth/registerWithInviteCode
Content-Type: application/json

{
  "openid": "user_openid",
  "userInfo": {
    "nickName": "ç”¨æˆ·æ˜µç§°",
    "avatarUrl": "å¤´åƒåœ°å€",
    "gender": 1,
    "country": "ä¸­å›½",
    "province": "åŒ—äº¬",
    "city": "åŒ—äº¬",
    "language": "zh_CN"
  },
  "inviteCode": "AAA"
}
```

#### 3. éªŒè¯é‚€è¯·ç 

```http
POST /api/auth/validateInviteCode
Content-Type: application/json

{
  "inviteCode": "ABC123"
}
```

#### 4. è·å–é‚€è¯·ç»Ÿè®¡

```http
GET /api/auth/inviteStats
Authorization: Bearer your_jwt_token
```

### è°ƒè¯•æ¥å£ï¼ˆä»…å¼€å‘ç¯å¢ƒï¼‰

#### æŸ¥çœ‹æ‰€æœ‰ç”¨æˆ·

```http
GET /api/debug/users
```

#### æŸ¥çœ‹é‚€è¯·ç ç»Ÿè®¡

```http
GET /api/debug/invite-codes
```

#### æµ‹è¯•é‚€è¯·ç éªŒè¯

```http
POST /api/debug/test-invite-code
Content-Type: application/json

{
  "inviteCode": "AAA"
}
```

#### æ¸…ç©ºæµ‹è¯•æ•°æ®

```http
DELETE /api/debug/clear
```

## ğŸ”„ é‚€è¯·ç ä¸šåŠ¡æµç¨‹

### 1. å•†æˆ·æ³¨å†Œæµç¨‹

1. å•†æˆ·ä½¿ç”¨ç³»ç»Ÿé»˜è®¤é‚€è¯·ç  `AAA` æ³¨å†Œ
2. ç³»ç»ŸéªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
3. åˆ›å»ºå•†æˆ·è´¦æˆ·å¹¶ç”Ÿæˆä¸ªäººé‚€è¯·ç ï¼ˆå¦‚ `XYZ789`ï¼‰
4. ç³»ç»Ÿé‚€è¯·ç  `AAA` æ ‡è®°ä¸ºå·²ä½¿ç”¨

### 2. ç”¨æˆ·æ³¨å†Œæµç¨‹

1. ç”¨æˆ·é€šè¿‡åˆ†äº«é“¾æ¥æ‰“å¼€å°ç¨‹åº
2. å¾®ä¿¡ç™»å½•è·å– openid
3. å¦‚æœæ˜¯æ–°ç”¨æˆ·ï¼Œè¦æ±‚è¾“å…¥é‚€è¯·ç 
4. éªŒè¯é‚€è¯·ç æœ‰æ•ˆæ€§
5. åˆ›å»ºç”¨æˆ·è´¦æˆ·å¹¶å»ºç«‹é‚€è¯·å…³ç³»

### 3. é‚€è¯·å…³ç³»

- æ¯ä¸ªç”¨æˆ·åªèƒ½é€šè¿‡ä¸€ä¸ªé‚€è¯·ç æ³¨å†Œ
- é‚€è¯·ç å¯ä»¥è¢«å¤šæ¬¡ä½¿ç”¨
- ç³»ç»Ÿè¿½è¸ªå®Œæ•´çš„é‚€è¯·å…³ç³»é“¾
- æ”¯æŒé‚€è¯·ç»Ÿè®¡å’Œåˆ†æ

## ğŸ”§ æ•°æ®æ¨¡å‹

### ç”¨æˆ·æ¨¡å‹

```javascript
{
  id: 1,                           // ç”¨æˆ·ID
  openid: "wx_openid",            // å¾®ä¿¡OpenID
  nickname: "ç”¨æˆ·æ˜µç§°",            // æ˜µç§°
  avatar_url: "å¤´åƒåœ°å€",          // å¤´åƒ
  invite_code: "ABC123",          // ç”¨æˆ·çš„é‚€è¯·ç 
  invite_from: "AAA",             // æ³¨å†Œæ—¶ä½¿ç”¨çš„é‚€è¯·ç 
  inviter_id: 1,                  // é‚€è¯·äººID
  created_at: "2024-01-01",       // åˆ›å»ºæ—¶é—´
  // ... å…¶ä»–å­—æ®µ
}
```

### é‚€è¯·ç æ˜ å°„

```javascript
{
  "AAA": null,        // ç³»ç»Ÿé‚€è¯·ç 
  "ABC123": 1,        // ç”¨æˆ·1çš„é‚€è¯·ç 
  "XYZ789": 2,        // ç”¨æˆ·2çš„é‚€è¯·ç 
}
```

## ğŸ³ Docker éƒ¨ç½²

### æ„å»ºé•œåƒ

```bash
npm run docker:build
```

### è¿è¡Œå®¹å™¨

```bash
npm run docker:run
```

### Docker Compose

```bash
docker-compose up -d
```

## ğŸ“ å¼€å‘è¯´æ˜

### å†…å­˜å­˜å‚¨æ¨¡å¼

å½“å‰ä½¿ç”¨å†…å­˜å­˜å‚¨æ¨¡å¼ï¼Œæ•°æ®åœ¨æœåŠ¡é‡å¯åä¼šä¸¢å¤±ã€‚é€‚ç”¨äºå¼€å‘å’Œæµ‹è¯•ç¯å¢ƒã€‚

### æ•°æ®åº“æ¨¡å¼

ç”Ÿäº§ç¯å¢ƒå¯ä»¥åˆ‡æ¢åˆ°æ•°æ®åº“æ¨¡å¼ï¼š

1. ä¿®æ”¹æ¨¡å‹å¼•ç”¨ï¼š`require("../models/User")` æ›¿æ¢ `require("../models/MemoryUser")`
2. é…ç½®æ•°æ®åº“è¿æ¥
3. è¿è¡Œæ•°æ®åº“è¿ç§»

### å®‰å…¨è€ƒè™‘

- JWT Token æœ‰æ•ˆæœŸé™åˆ¶
- è¯·æ±‚é¢‘ç‡é™åˆ¶
- è¾“å…¥æ•°æ®éªŒè¯
- CORS é…ç½®
- é”™è¯¯ä¿¡æ¯éšè—

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **ç”Ÿäº§ç¯å¢ƒ**ï¼šè¯·ç¡®ä¿ä¿®æ”¹é»˜è®¤çš„ JWT_SECRET
2. **å¾®ä¿¡é…ç½®**ï¼šéœ€è¦é…ç½®æ­£ç¡®çš„å°ç¨‹åº AppID å’Œ Secret
3. **åŸŸåé…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒéœ€è¦é…ç½®æ­£ç¡®çš„åŸŸåå’Œ HTTPS
4. **æ•°æ®æŒä¹…åŒ–**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨æ•°æ®åº“å­˜å‚¨

## ğŸ“ æ”¯æŒ

å¦‚æœ‰é—®é¢˜è¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æäº¤ Issueã€‚

## ğŸ“š è®¸å¯è¯

MIT License
